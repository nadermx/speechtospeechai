{% extends "base.html" %}
{% load static %}

{% block content %}
<!-- Compact Header + Tool -->
<section class="py-4 bg-light border-bottom">
    <div class="container">
        <div class="d-flex flex-wrap align-items-center justify-content-between gap-3">
            <div>
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb mb-1 small">
                        <li class="breadcrumb-item"><a href="/">Home</a></li>
                        <li class="breadcrumb-item active">Speech to Text</li>
                    </ol>
                </nav>
                <h1 class="h3 mb-0"><i class="bi bi-mic text-info me-2"></i>Speech to Text</h1>
            </div>
            <div class="d-flex flex-wrap gap-2">
                <span class="badge bg-info"><i class="bi bi-check-circle me-1"></i>99%+ Accuracy</span>
                <span class="badge bg-primary"><i class="bi bi-globe me-1"></i>100+ Languages</span>
                <span class="badge bg-success"><i class="bi bi-people me-1"></i>Speaker Diarization</span>
            </div>
        </div>
    </div>
</section>

<!-- Main Tool -->
<section class="py-4">
    <div class="container">
        <div class="row g-4">
            <div class="col-lg-8">
                <!-- Upload Card -->
                <div class="card shadow-sm">
                    <div class="card-header bg-white">
                        <ul class="nav nav-tabs card-header-tabs">
                            <li class="nav-item">
                                <a class="nav-link active" data-bs-toggle="tab" href="#upload-tab">
                                    <i class="bi bi-upload me-2"></i>Upload File
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" data-bs-toggle="tab" href="#record-tab">
                                    <i class="bi bi-mic me-2"></i>Record
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" data-bs-toggle="tab" href="#url-tab">
                                    <i class="bi bi-link-45deg me-2"></i>URL
                                </a>
                            </li>
                        </ul>
                    </div>
                    <div class="card-body p-4">
                        <div class="tab-content">
                            <div class="tab-pane fade show active" id="upload-tab">
                                <div class="border-2 border-dashed rounded p-5 text-center bg-light" id="dropzone">
                                    <i class="bi bi-cloud-arrow-up display-3 text-info mb-3"></i>
                                    <h5>Drop your audio or video file here</h5>
                                    <p class="text-muted mb-3">or click to browse</p>
                                    <input type="file" class="d-none" id="mediaFile" accept="audio/*,video/*">
                                    <button class="btn btn-info" onclick="document.getElementById('mediaFile').click()">
                                        <i class="bi bi-folder2-open me-2"></i>Choose File
                                    </button>
                                    <p class="text-muted small mt-3 mb-0">MP3, WAV, MP4, MOV, MKV, and more (max 500MB)</p>
                                </div>
                            </div>
                            <div class="tab-pane fade" id="record-tab">
                                <div class="text-center p-4">
                                    <button class="btn btn-lg btn-info rounded-circle p-4" style="width: 100px; height: 100px;">
                                        <i class="bi bi-mic fs-1"></i>
                                    </button>
                                    <p class="mt-3 text-muted">Click to start recording</p>
                                </div>
                            </div>
                            <div class="tab-pane fade" id="url-tab">
                                <div class="mb-3">
                                    <label class="form-label">Audio/Video URL</label>
                                    <input type="url" class="form-control form-control-lg" placeholder="https://example.com/video.mp4">
                                    <small class="text-muted">Supports YouTube, Vimeo, direct file URLs</small>
                                </div>
                                <button class="btn btn-info"><i class="bi bi-download me-2"></i>Fetch & Transcribe</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Settings -->
                <div class="card shadow-sm mt-4">
                    <div class="card-header bg-white">
                        <h5 class="mb-0"><i class="bi bi-gear me-2"></i>Transcription Settings</h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Model</label>
                                <select class="form-select">
                                    <option value="whisper-large-v3" selected>Whisper Large v3 (Best)</option>
                                    <option value="whisper-turbo">Whisper Turbo (Faster)</option>
                                    <option value="canary-qwen-2.5b">Canary Qwen 2.5B (Highest Accuracy)</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Language</label>
                                <select class="form-select">
                                    <option value="auto" selected>Auto-detect</option>
                                    <option value="en">English</option>
                                    <option value="es">Spanish</option>
                                    <option value="fr">French</option>
                                    <option value="de">German</option>
                                    <option value="zh">Chinese</option>
                                    <option value="ja">Japanese</option>
                                </select>
                            </div>
                            <div class="col-12">
                                <label class="form-label">Features</label>
                                <div class="row g-2">
                                    <div class="col-md-4">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="diarization" checked>
                                            <label class="form-check-label" for="diarization">Speaker Diarization</label>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="timestamps" checked>
                                            <label class="form-check-label" for="timestamps">Word Timestamps</label>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="punctuation" checked>
                                            <label class="form-check-label" for="punctuation">Auto Punctuation</label>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="summary">
                                            <label class="form-check-label" for="summary">Generate Summary</label>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="translate">
                                            <label class="form-check-label" for="translate">Translate to English</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Generate Button -->
                <div class="d-grid mt-4">
                    <button class="btn btn-info btn-lg text-white" id="transcribeBtn" disabled>
                        <i class="bi bi-play-circle me-2"></i>Transcribe (1 Credit/minute)
                    </button>
                </div>

                <!-- Results -->
                <div class="card shadow-sm mt-4 d-none" id="resultsCard">
                    <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-file-text me-2"></i>Transcription</h5>
                        <div class="btn-group">
                            <button class="btn btn-sm btn-light"><i class="bi bi-clipboard me-1"></i>Copy</button>
                            <button class="btn btn-sm btn-light dropdown-toggle dropdown-toggle-split" data-bs-toggle="dropdown"></button>
                            <ul class="dropdown-menu dropdown-menu-end">
                                <li><a class="dropdown-item" href="#"><i class="bi bi-filetype-txt me-2"></i>Download TXT</a></li>
                                <li><a class="dropdown-item" href="#"><i class="bi bi-filetype-json me-2"></i>Download JSON</a></li>
                                <li><a class="dropdown-item" href="#"><i class="bi bi-badge-cc me-2"></i>Download SRT</a></li>
                                <li><a class="dropdown-item" href="#"><i class="bi bi-file-earmark me-2"></i>Download VTT</a></li>
                            </ul>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="bg-light rounded p-3" id="transcriptionOutput" style="max-height: 400px; overflow-y: auto;">
                            <!-- Transcription will appear here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="col-lg-4">
                <!-- Credits -->
                <div class="card shadow-sm mb-4">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="mb-0"><i class="bi bi-coin me-2"></i>Your Credits</h6>
                            <span class="badge bg-info fs-6">{{ user.credits|default:10 }}</span>
                        </div>
                        <p class="small text-muted mb-2">1 credit = 1 minute of audio</p>
                        <a href="/pricing/" class="small">Get more credits</a>
                    </div>
                </div>

                <!-- Supported Formats -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-white">
                        <h6 class="mb-0"><i class="bi bi-file-earmark-music me-2"></i>Supported Formats</h6>
                    </div>
                    <div class="card-body">
                        <div class="row g-2">
                            <div class="col-4"><span class="badge bg-light text-dark w-100">MP3</span></div>
                            <div class="col-4"><span class="badge bg-light text-dark w-100">WAV</span></div>
                            <div class="col-4"><span class="badge bg-light text-dark w-100">FLAC</span></div>
                            <div class="col-4"><span class="badge bg-light text-dark w-100">MP4</span></div>
                            <div class="col-4"><span class="badge bg-light text-dark w-100">MOV</span></div>
                            <div class="col-4"><span class="badge bg-light text-dark w-100">MKV</span></div>
                            <div class="col-4"><span class="badge bg-light text-dark w-100">WebM</span></div>
                            <div class="col-4"><span class="badge bg-light text-dark w-100">M4A</span></div>
                            <div class="col-4"><span class="badge bg-light text-dark w-100">OGG</span></div>
                        </div>
                    </div>
                </div>

                <!-- Languages -->
                <div class="card shadow-sm">
                    <div class="card-header bg-white">
                        <h6 class="mb-0"><i class="bi bi-translate me-2"></i>100+ Languages</h6>
                    </div>
                    <div class="card-body">
                        <p class="small text-muted mb-2">Including:</p>
                        <div class="d-flex flex-wrap gap-1">
                            <span class="badge bg-secondary">English</span>
                            <span class="badge bg-secondary">Spanish</span>
                            <span class="badge bg-secondary">French</span>
                            <span class="badge bg-secondary">German</span>
                            <span class="badge bg-secondary">Chinese</span>
                            <span class="badge bg-secondary">Japanese</span>
                            <span class="badge bg-secondary">Korean</span>
                            <span class="badge bg-secondary">Arabic</span>
                            <span class="badge bg-secondary">Hindi</span>
                            <span class="badge bg-secondary">+90 more</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Features -->
<section class="py-5 bg-light">
    <div class="container">
        <h2 class="text-center fw-bold mb-5">Advanced Features</h2>
        <div class="row g-4">
            <div class="col-md-4">
                <div class="card h-100 border-0 shadow-sm">
                    <div class="card-body text-center p-4">
                        <i class="bi bi-people display-4 text-info mb-3"></i>
                        <h5>Speaker Diarization</h5>
                        <p class="text-muted small">Automatically identify and label different speakers in your audio.</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card h-100 border-0 shadow-sm">
                    <div class="card-body text-center p-4">
                        <i class="bi bi-clock-history display-4 text-primary mb-3"></i>
                        <h5>Word Timestamps</h5>
                        <p class="text-muted small">Get precise timing for every word, perfect for subtitles and editing.</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card h-100 border-0 shadow-sm">
                    <div class="card-body text-center p-4">
                        <i class="bi bi-file-text display-4 text-success mb-3"></i>
                        <h5>Auto Summarization</h5>
                        <p class="text-muted small">Get an AI-generated summary of your transcribed content.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const transcribeBtn = document.getElementById('transcribeBtn');
    const resultsCard = document.getElementById('resultsCard');
    const transcriptionOutput = document.getElementById('transcriptionOutput');
    const recordTab = document.querySelector('[href="#record-tab"]');
    const recordBtn = document.querySelector('#record-tab button');
    const dropzone = document.getElementById('dropzone');
    const mediaFile = document.getElementById('mediaFile');
    const modelSelect = document.querySelector('select');
    const languageSelect = document.querySelectorAll('select')[1];

    let recognition = null;
    let isRecording = false;
    let finalTranscript = '';
    let uploadedFile = null;

    // Check for Web Speech API support (for live recording fallback)
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

    if (SpeechRecognition) {
        recognition = new SpeechRecognition();
        recognition.continuous = true;
        recognition.interimResults = true;
        recognition.lang = 'en-US';

        recognition.onresult = function(event) {
            let interimTranscript = '';
            for (let i = event.resultIndex; i < event.results.length; i++) {
                const transcript = event.results[i][0].transcript;
                if (event.results[i].isFinal) {
                    finalTranscript += transcript + ' ';
                } else {
                    interimTranscript += transcript;
                }
            }
            transcriptionOutput.innerHTML = `<p>${finalTranscript}</p><p class="text-muted">${interimTranscript}</p>`;
            resultsCard.classList.remove('d-none');
        };

        recognition.onerror = function(event) {
            console.error('Speech recognition error:', event.error);
            stopRecording();
        };

        recognition.onend = function() {
            if (isRecording) {
                recognition.start();
            }
        };
    }

    function startRecording() {
        if (!recognition) {
            alert('Speech recognition is not supported in your browser. Try Chrome.');
            return;
        }
        isRecording = true;
        finalTranscript = '';
        recognition.start();
        recordBtn.classList.remove('btn-info');
        recordBtn.classList.add('btn-danger');
        recordBtn.innerHTML = '<i class="bi bi-stop-circle fs-1"></i>';
        transcriptionOutput.innerHTML = '<p class="text-muted">Listening...</p>';
        resultsCard.classList.remove('d-none');
    }

    function stopRecording() {
        isRecording = false;
        if (recognition) {
            recognition.stop();
        }
        recordBtn.classList.remove('btn-danger');
        recordBtn.classList.add('btn-info');
        recordBtn.innerHTML = '<i class="bi bi-mic fs-1"></i>';
    }

    // Record button
    recordBtn.addEventListener('click', function() {
        if (isRecording) {
            stopRecording();
        } else {
            startRecording();
        }
    });

    // File upload
    mediaFile.addEventListener('change', function() {
        if (this.files.length > 0) {
            const file = this.files[0];
            uploadedFile = file;
            dropzone.innerHTML = `
                <i class="bi bi-file-earmark-music display-3 text-success mb-3"></i>
                <h5>${file.name}</h5>
                <p class="text-muted mb-3">${(file.size / 1024 / 1024).toFixed(2)} MB</p>
                <audio controls class="w-100 mb-3" src="${URL.createObjectURL(file)}"></audio>
                <button class="btn btn-outline-danger btn-sm" id="removeFile">Remove</button>
            `;
            document.getElementById('removeFile').addEventListener('click', function() {
                location.reload();
            });
            transcribeBtn.disabled = false;
            transcribeBtn.innerHTML = '<i class="bi bi-play-circle me-2"></i>Transcribe (1 Credit/minute)';
        }
    });

    // Drag and drop
    dropzone.addEventListener('dragover', function(e) {
        e.preventDefault();
        this.classList.add('border-info');
    });
    dropzone.addEventListener('dragleave', function(e) {
        e.preventDefault();
        this.classList.remove('border-info');
    });
    dropzone.addEventListener('drop', function(e) {
        e.preventDefault();
        this.classList.remove('border-info');
        if (e.dataTransfer.files.length > 0) {
            mediaFile.files = e.dataTransfer.files;
            mediaFile.dispatchEvent(new Event('change'));
        }
    });

    // Transcribe button - uses real API
    transcribeBtn.addEventListener('click', async function() {
        if (!uploadedFile) {
            alert('Please upload an audio or video file first.');
            return;
        }

        this.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Uploading...';
        this.disabled = true;

        try {
            // Get options
            const options = {
                model: modelSelect.value,
                language: languageSelect.value,
                diarize: document.getElementById('diarization').checked,
                timestamps: document.getElementById('timestamps').checked
            };

            // Call STT API
            const result = await SpeechAPI.speechToText(uploadedFile, options);

            this.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Transcribing...';

            // Poll for results
            const finalResult = await SpeechAPI.pollResults(result.uuid, (status) => {
                if (status.status === 'queued') {
                    this.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Queued...';
                } else if (status.status === 'processing') {
                    const progress = status.progress ? ` (${Math.round(status.progress * 100)}%)` : '';
                    this.innerHTML = `<span class="spinner-border spinner-border-sm me-2"></span>Transcribing${progress}...`;
                }
            });

            // Display results
            resultsCard.classList.remove('d-none');
            finalTranscript = finalResult.text || '';

            // Format output based on features
            let outputHtml = '';

            if (finalResult.segments && document.getElementById('diarization').checked) {
                // Show speaker diarization
                outputHtml = finalResult.segments.map(seg => {
                    const speaker = seg.speaker ? `<strong class="text-primary">${seg.speaker}:</strong> ` : '';
                    const timestamp = document.getElementById('timestamps').checked ?
                        `<small class="text-muted">[${formatTime(seg.start)} - ${formatTime(seg.end)}]</small> ` : '';
                    return `<p class="mb-2">${timestamp}${speaker}${seg.text}</p>`;
                }).join('');
            } else if (finalResult.words && document.getElementById('timestamps').checked) {
                // Show word timestamps
                outputHtml = `<p>${finalResult.words.map(w =>
                    `<span class="word-timestamp" data-start="${w.start}" title="${formatTime(w.start)}">${w.word}</span>`
                ).join(' ')}</p>`;
            } else {
                // Plain text
                outputHtml = `<p>${finalTranscript}</p>`;
            }

            transcriptionOutput.innerHTML = outputHtml;

            // Add download handlers
            setupDownloadHandlers(finalResult);

            this.innerHTML = '<i class="bi bi-play-circle me-2"></i>Transcribe (1 Credit/minute)';
            this.disabled = false;

        } catch (error) {
            console.error('Transcription error:', error);

            resultsCard.classList.remove('d-none');
            transcriptionOutput.innerHTML = `
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    ${error.message || 'Transcription failed. Please try again.'}
                </div>
                ${error.message && error.message.includes('API key') ? `
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>
                        File transcription requires an API key. <a href="/pricing/" class="alert-link">Sign up</a> to get started.
                    </div>
                ` : ''}
            `;

            this.innerHTML = '<i class="bi bi-play-circle me-2"></i>Transcribe (1 Credit/minute)';
            this.disabled = false;
        }
    });

    function formatTime(seconds) {
        const mins = Math.floor(seconds / 60);
        const secs = Math.floor(seconds % 60);
        return `${mins}:${secs.toString().padStart(2, '0')}`;
    }

    function setupDownloadHandlers(result) {
        const dropdownItems = resultsCard.querySelectorAll('.dropdown-item');

        // TXT download
        dropdownItems[0].addEventListener('click', function(e) {
            e.preventDefault();
            downloadFile(result.text || finalTranscript, 'transcription.txt', 'text/plain');
        });

        // JSON download
        dropdownItems[1].addEventListener('click', function(e) {
            e.preventDefault();
            downloadFile(JSON.stringify(result, null, 2), 'transcription.json', 'application/json');
        });

        // SRT download
        dropdownItems[2].addEventListener('click', function(e) {
            e.preventDefault();
            const srt = generateSRT(result);
            downloadFile(srt, 'transcription.srt', 'text/plain');
        });

        // VTT download
        dropdownItems[3].addEventListener('click', function(e) {
            e.preventDefault();
            const vtt = generateVTT(result);
            downloadFile(vtt, 'transcription.vtt', 'text/vtt');
        });
    }

    function downloadFile(content, filename, type) {
        const blob = new Blob([content], { type });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        a.click();
        URL.revokeObjectURL(url);
    }

    function generateSRT(result) {
        if (!result.segments) return result.text || finalTranscript;
        return result.segments.map((seg, i) => {
            const start = formatSRTTime(seg.start);
            const end = formatSRTTime(seg.end);
            return `${i + 1}\n${start} --> ${end}\n${seg.text}\n`;
        }).join('\n');
    }

    function generateVTT(result) {
        let vtt = 'WEBVTT\n\n';
        if (!result.segments) return vtt + (result.text || finalTranscript);
        result.segments.forEach((seg, i) => {
            const start = formatVTTTime(seg.start);
            const end = formatVTTTime(seg.end);
            vtt += `${i + 1}\n${start} --> ${end}\n${seg.text}\n\n`;
        });
        return vtt;
    }

    function formatSRTTime(seconds) {
        const h = Math.floor(seconds / 3600);
        const m = Math.floor((seconds % 3600) / 60);
        const s = Math.floor(seconds % 60);
        const ms = Math.floor((seconds % 1) * 1000);
        return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')},${ms.toString().padStart(3, '0')}`;
    }

    function formatVTTTime(seconds) {
        const h = Math.floor(seconds / 3600);
        const m = Math.floor((seconds % 3600) / 60);
        const s = Math.floor(seconds % 60);
        const ms = Math.floor((seconds % 1) * 1000);
        return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}.${ms.toString().padStart(3, '0')}`;
    }

    // Copy button
    document.querySelector('#resultsCard .btn-light').addEventListener('click', function() {
        navigator.clipboard.writeText(finalTranscript || transcriptionOutput.textContent);
        this.innerHTML = '<i class="bi bi-check me-1"></i>Copied!';
        setTimeout(() => { this.innerHTML = '<i class="bi bi-clipboard me-1"></i>Copy'; }, 2000);
    });

    // Language select for live recording
    languageSelect.addEventListener('change', function() {
        if (recognition) {
            const langMap = {
                'auto': 'en-US', 'en': 'en-US', 'es': 'es-ES', 'fr': 'fr-FR',
                'de': 'de-DE', 'zh': 'zh-CN', 'ja': 'ja-JP'
            };
            recognition.lang = langMap[this.value] || 'en-US';
        }
    });
});
</script>
{% endblock %}
