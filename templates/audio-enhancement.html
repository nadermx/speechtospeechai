{% extends "base.html" %}
{% load static %}

{% block content %}
<!-- Compact Header + Tool -->
<section class="py-4 bg-light border-bottom">
    <div class="container">
        <div class="d-flex flex-wrap align-items-center justify-content-between gap-3">
            <div>
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb mb-1 small">
                        <li class="breadcrumb-item"><a href="/">Home</a></li>
                        <li class="breadcrumb-item active">Audio Enhancement</li>
                    </ol>
                </nav>
                <h1 class="h3 mb-0"><i class="bi bi-stars text-warning me-2"></i>Audio Enhancement</h1>
            </div>
            <div class="d-flex flex-wrap gap-2">
                <span class="badge bg-warning text-dark"><i class="bi bi-soundwave me-1"></i>Noise Removal</span>
                <span class="badge bg-success"><i class="bi bi-mic me-1"></i>Voice Enhancement</span>
                <span class="badge bg-info"><i class="bi bi-magic me-1"></i>Audio Restoration</span>
            </div>
        </div>
    </div>
</section>

<!-- Main Tool -->
<section class="py-4">
    <div class="container">
        <div class="row g-4">
            <div class="col-lg-8">
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-white">
                        <h5 class="mb-0"><i class="bi bi-upload me-2"></i>Upload Audio</h5>
                    </div>
                    <div class="card-body">
                        <div class="border-2 border-dashed rounded p-4 text-center bg-light">
                            <i class="bi bi-cloud-arrow-up display-4 text-warning mb-3"></i>
                            <h6>Upload audio to enhance</h6>
                            <p class="text-muted small mb-3">MP3, WAV, FLAC supported (max 500MB)</p>
                            <button class="btn btn-warning">
                                <i class="bi bi-upload me-2"></i>Choose File
                            </button>
                        </div>
                    </div>
                </div>

                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-white">
                        <h5 class="mb-0"><i class="bi bi-sliders me-2"></i>Enhancement Options</h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-4">
                            <div class="col-md-6">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="noiseRemoval" checked>
                                    <label class="form-check-label" for="noiseRemoval">
                                        <strong>Noise Removal</strong>
                                        <br><small class="text-muted">Remove background noise</small>
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="voiceEnhance" checked>
                                    <label class="form-check-label" for="voiceEnhance">
                                        <strong>Voice Enhancement</strong>
                                        <br><small class="text-muted">Improve clarity</small>
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="deReverb">
                                    <label class="form-check-label" for="deReverb">
                                        <strong>De-Reverb</strong>
                                        <br><small class="text-muted">Remove room echo</small>
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="normalize">
                                    <label class="form-check-label" for="normalize">
                                        <strong>Normalize Levels</strong>
                                        <br><small class="text-muted">Balance audio volume</small>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="d-grid">
                    <button class="btn btn-warning btn-lg" disabled>
                        <i class="bi bi-stars me-2"></i>Enhance Audio (1 Credit/min)
                    </button>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="card shadow-sm mb-4">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="mb-0"><i class="bi bi-coin me-2"></i>Your Credits</h6>
                            <span class="badge bg-warning text-dark fs-6">{{ user.credits|default:10 }}</span>
                        </div>
                        <a href="/pricing/" class="small">Get more credits</a>
                    </div>
                </div>

                <div class="card shadow-sm">
                    <div class="card-header bg-white">
                        <h6 class="mb-0"><i class="bi bi-lightbulb me-2"></i>Best For</h6>
                    </div>
                    <div class="card-body">
                        <ul class="list-unstyled mb-0">
                            <li class="mb-2"><i class="bi bi-check text-success me-2"></i>Podcast recordings</li>
                            <li class="mb-2"><i class="bi bi-check text-success me-2"></i>Interview audio</li>
                            <li class="mb-2"><i class="bi bi-check text-success me-2"></i>Voice overs</li>
                            <li><i class="bi bi-check text-success me-2"></i>Old recordings</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const uploadBtn = document.querySelector('.btn-warning');
    const dropzone = document.querySelector('.border-dashed');
    const enhanceBtn = document.querySelector('.btn-lg');
    let hasFile = false;
    let audioFile = null;

    // Create hidden file input
    const fileInput = document.createElement('input');
    fileInput.type = 'file';
    fileInput.accept = 'audio/*';
    fileInput.style.display = 'none';
    document.body.appendChild(fileInput);

    uploadBtn.addEventListener('click', () => fileInput.click());

    fileInput.addEventListener('change', function() {
        if (this.files.length > 0) {
            const file = this.files[0];
            hasFile = true;
            audioFile = file;
            dropzone.innerHTML = `
                <i class="bi bi-file-earmark-music display-4 text-success mb-3"></i>
                <h6>${file.name}</h6>
                <p class="text-muted small mb-2">${(file.size / 1024 / 1024).toFixed(2)} MB</p>
                <audio controls class="w-100 mb-2" id="originalPlayer" src="${URL.createObjectURL(file)}"></audio>
                <button class="btn btn-outline-danger btn-sm" id="removeFile">Remove</button>
            `;
            document.getElementById('removeFile').addEventListener('click', function() {
                location.reload();
            });
            enhanceBtn.disabled = false;
        }
    });

    // Drag and drop
    dropzone.addEventListener('dragover', e => { e.preventDefault(); dropzone.classList.add('border-warning'); });
    dropzone.addEventListener('dragleave', () => dropzone.classList.remove('border-warning'));
    dropzone.addEventListener('drop', function(e) {
        e.preventDefault();
        dropzone.classList.remove('border-warning');
        if (e.dataTransfer.files.length > 0) {
            fileInput.files = e.dataTransfer.files;
            fileInput.dispatchEvent(new Event('change'));
        }
    });

    // Enhance button - uses real API
    enhanceBtn.addEventListener('click', async function() {
        if (!hasFile || !audioFile) return;

        const options = {
            denoise: document.getElementById('noiseRemoval').checked,
            voice_enhance: document.getElementById('voiceEnhance').checked,
            dereverb: document.getElementById('deReverb').checked,
            normalize: document.getElementById('normalize').checked
        };

        if (!options.denoise && !options.voice_enhance && !options.dereverb && !options.normalize) {
            alert('Please select at least one enhancement option.');
            return;
        }

        this.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Uploading...';
        this.disabled = true;

        // Remove existing result
        const existingResult = document.getElementById('resultCard');
        if (existingResult) existingResult.remove();

        try {
            // Call audio enhancement API
            const result = await SpeechAPI.audioEnhance(audioFile, options);

            this.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Enhancing...';

            // Poll for results
            const finalResult = await SpeechAPI.pollResults(result.uuid, (status) => {
                if (status.status === 'queued') {
                    this.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Queued...';
                } else if (status.status === 'processing') {
                    const progress = status.progress ? ` (${Math.round(status.progress * 100)}%)` : '';
                    this.innerHTML = `<span class="spinner-border spinner-border-sm me-2"></span>Enhancing${progress}...`;
                }
            });

            // Build applied effects list
            const appliedEffects = [];
            if (options.denoise) appliedEffects.push('Noise Removal');
            if (options.voice_enhance) appliedEffects.push('Voice Enhancement');
            if (options.dereverb) appliedEffects.push('De-Reverb');
            if (options.normalize) appliedEffects.push('Normalization');

            const resultHtml = `
                <div class="card shadow-sm mt-4" id="resultCard">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0"><i class="bi bi-check-circle me-2"></i>Enhancement Complete</h5>
                    </div>
                    <div class="card-body">
                        <p class="text-muted mb-2">Applied: <strong>${appliedEffects.join(', ')}</strong></p>
                        <div class="row g-3 mb-3">
                            <div class="col-md-6">
                                <label class="form-label small text-muted">Original</label>
                                <audio controls class="w-100" src="${URL.createObjectURL(audioFile)}"></audio>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label small text-muted">Enhanced</label>
                                <audio controls class="w-100" src="${finalResult.output_url}"></audio>
                            </div>
                        </div>
                        <div class="d-flex gap-2">
                            <a href="${finalResult.output_url}" download="enhanced-audio.wav" class="btn btn-success">
                                <i class="bi bi-download me-2"></i>Download Enhanced
                            </a>
                            <button class="btn btn-outline-secondary" onclick="location.reload()">
                                <i class="bi bi-arrow-repeat me-2"></i>Enhance Another
                            </button>
                        </div>
                    </div>
                </div>
            `;

            enhanceBtn.insertAdjacentHTML('afterend', resultHtml);

            this.innerHTML = '<i class="bi bi-stars me-2"></i>Enhance Audio (1 Credit/min)';
            this.disabled = false;

        } catch (error) {
            console.error('Enhancement error:', error);

            const errorHtml = `
                <div class="card shadow-sm mt-4" id="resultCard">
                    <div class="card-header bg-danger text-white">
                        <h5 class="mb-0"><i class="bi bi-exclamation-triangle me-2"></i>Enhancement Failed</h5>
                    </div>
                    <div class="card-body">
                        <p class="text-muted mb-3">${error.message || 'An error occurred during audio enhancement.'}</p>
                        ${error.message && error.message.includes('API key') ? `
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle me-2"></i>
                                Audio enhancement requires an API key. <a href="/pricing/" class="alert-link">Sign up</a> to get started.
                            </div>
                        ` : ''}
                        <button class="btn btn-outline-primary" onclick="location.reload()">
                            <i class="bi bi-arrow-repeat me-2"></i>Try Again
                        </button>
                    </div>
                </div>
            `;

            enhanceBtn.insertAdjacentHTML('afterend', errorHtml);

            this.innerHTML = '<i class="bi bi-stars me-2"></i>Enhance Audio (1 Credit/min)';
            this.disabled = false;
        }
    });
});
</script>
{% endblock %}
