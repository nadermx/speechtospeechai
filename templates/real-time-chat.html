{% extends "base.html" %}
{% load static %}

{% block content %}
<!-- Compact Header + Tool -->
<section class="py-4 bg-light border-bottom">
    <div class="container">
        <div class="d-flex flex-wrap align-items-center justify-content-between gap-3">
            <div>
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb mb-1 small">
                        <li class="breadcrumb-item"><a href="/">Home</a></li>
                        <li class="breadcrumb-item active">Real-Time Voice Chat</li>
                    </ol>
                </nav>
                <h1 class="h3 mb-0"><i class="bi bi-headset text-danger me-2"></i>Real-Time Voice Chat</h1>
            </div>
            <div class="d-flex flex-wrap gap-2">
                <span class="badge bg-danger"><i class="bi bi-lightning me-1"></i>&lt;200ms Latency</span>
                <span class="badge bg-primary"><i class="bi bi-arrows-fullscreen me-1"></i>Full Duplex</span>
                <span class="badge bg-success"><i class="bi bi-person-badge me-1"></i>Custom Personas</span>
            </div>
        </div>
    </div>
</section>

<!-- Chat Interface -->
<section class="py-4">
    <div class="container">
        <div class="row g-4">
            <!-- Main Chat Area -->
            <div class="col-lg-8">
                <div class="card shadow-sm" style="min-height: 600px;">
                    <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center">
                            <div class="rounded-circle bg-success p-2 me-3" style="width: 12px; height: 12px;"></div>
                            <div>
                                <h6 class="mb-0">AI Assistant</h6>
                                <small class="text-muted">Online - Ready to chat</small>
                            </div>
                        </div>
                        <div class="btn-group">
                            <button class="btn btn-sm btn-outline-light" title="Settings">
                                <i class="bi bi-gear"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-light" title="End call">
                                <i class="bi bi-telephone-x"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body d-flex flex-column">
                        <!-- Chat Messages -->
                        <div class="flex-grow-1 overflow-auto mb-4" id="chatMessages" style="max-height: 400px;">
                            <div class="text-center py-5">
                                <i class="bi bi-headset display-1 text-muted opacity-25"></i>
                                <h5 class="text-muted mt-3">Ready for Voice Conversation</h5>
                                <p class="text-muted small">Click the microphone button to start talking</p>
                            </div>
                        </div>

                        <!-- Voice Visualizer -->
                        <div class="bg-dark rounded p-4 mb-4">
                            <div class="row align-items-center">
                                <div class="col">
                                    <div class="d-flex align-items-center gap-3">
                                        <div class="rounded-circle bg-primary p-3">
                                            <i class="bi bi-person-circle fs-4 text-white"></i>
                                        </div>
                                        <div>
                                            <small class="text-muted">You</small>
                                            <div class="d-flex gap-1" id="userWaveform">
                                                <div class="bg-primary" style="width: 3px; height: 20px; border-radius: 2px;"></div>
                                                <div class="bg-primary" style="width: 3px; height: 15px; border-radius: 2px;"></div>
                                                <div class="bg-primary" style="width: 3px; height: 25px; border-radius: 2px;"></div>
                                                <div class="bg-primary" style="width: 3px; height: 10px; border-radius: 2px;"></div>
                                                <div class="bg-primary" style="width: 3px; height: 18px; border-radius: 2px;"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-auto">
                                    <div class="d-flex gap-2">
                                        <button class="btn btn-outline-light btn-sm" id="muteBtn">
                                            <i class="bi bi-mic"></i>
                                        </button>
                                        <button class="btn btn-outline-light btn-sm" id="speakerBtn">
                                            <i class="bi bi-volume-up"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="col text-end">
                                    <div class="d-flex align-items-center justify-content-end gap-3">
                                        <div>
                                            <small class="text-muted">AI</small>
                                            <div class="d-flex gap-1" id="aiWaveform">
                                                <div class="bg-success" style="width: 3px; height: 12px; border-radius: 2px;"></div>
                                                <div class="bg-success" style="width: 3px; height: 20px; border-radius: 2px;"></div>
                                                <div class="bg-success" style="width: 3px; height: 8px; border-radius: 2px;"></div>
                                                <div class="bg-success" style="width: 3px; height: 22px; border-radius: 2px;"></div>
                                                <div class="bg-success" style="width: 3px; height: 15px; border-radius: 2px;"></div>
                                            </div>
                                        </div>
                                        <div class="rounded-circle bg-success p-3">
                                            <i class="bi bi-robot fs-4 text-white"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Controls -->
                        <div class="text-center">
                            <button class="btn btn-danger btn-lg rounded-circle p-4" id="callBtn" style="width: 80px; height: 80px;">
                                <i class="bi bi-mic fs-2"></i>
                            </button>
                            <p class="text-muted small mt-2 mb-0">Press to start conversation</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="col-lg-4">
                <!-- Persona Settings -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-white">
                        <h6 class="mb-0"><i class="bi bi-person-gear me-2"></i>Persona Settings</h6>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label small fw-semibold">AI Role</label>
                            <select class="form-select form-select-sm">
                                <option value="assistant" selected>Helpful Assistant</option>
                                <option value="customer-service">Customer Service Agent</option>
                                <option value="tutor">Language Tutor</option>
                                <option value="interviewer">Interview Practice</option>
                                <option value="therapist">Supportive Listener</option>
                                <option value="custom">Custom Persona...</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label small fw-semibold">Voice</label>
                            <select class="form-select form-select-sm">
                                <option value="nova" selected>Nova (Female, Warm)</option>
                                <option value="onyx">Onyx (Male, Deep)</option>
                                <option value="shimmer">Shimmer (Female, Energetic)</option>
                                <option value="echo">Echo (Male, Neutral)</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label small fw-semibold">System Prompt</label>
                            <textarea class="form-control form-control-sm" rows="3" placeholder="You are a helpful AI assistant..."></textarea>
                        </div>
                    </div>
                </div>

                <!-- Voice Settings -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-white">
                        <h6 class="mb-0"><i class="bi bi-sliders me-2"></i>Voice Settings</h6>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label small">Speaking Speed</label>
                            <input type="range" class="form-range" min="0.5" max="1.5" step="0.1" value="1">
                        </div>
                        <div class="mb-3">
                            <label class="form-label small">Response Style</label>
                            <select class="form-select form-select-sm">
                                <option value="concise">Concise</option>
                                <option value="balanced" selected>Balanced</option>
                                <option value="detailed">Detailed</option>
                            </select>
                        </div>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="backchannels" checked>
                            <label class="form-check-label small" for="backchannels">Enable backchannels (uh-huh, etc.)</label>
                        </div>
                    </div>
                </div>

                <!-- Stats -->
                <div class="card shadow-sm">
                    <div class="card-header bg-white">
                        <h6 class="mb-0"><i class="bi bi-graph-up me-2"></i>Session Stats</h6>
                    </div>
                    <div class="card-body">
                        <div class="row g-2 text-center">
                            <div class="col-6">
                                <div class="bg-light rounded p-2">
                                    <div class="fs-4 fw-bold text-primary">0:00</div>
                                    <small class="text-muted">Duration</small>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="bg-light rounded p-2">
                                    <div class="fs-4 fw-bold text-success">--ms</div>
                                    <small class="text-muted">Latency</small>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="bg-light rounded p-2">
                                    <div class="fs-4 fw-bold text-info">0</div>
                                    <small class="text-muted">Turns</small>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="bg-light rounded p-2">
                                    <div class="fs-4 fw-bold text-warning">0</div>
                                    <small class="text-muted">Credits Used</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Features -->
<section class="py-5 bg-light">
    <div class="container">
        <h2 class="text-center fw-bold mb-5">Full-Duplex Capabilities</h2>
        <div class="row g-4">
            <div class="col-md-4">
                <div class="card h-100 border-0 shadow-sm">
                    <div class="card-body text-center p-4">
                        <i class="bi bi-arrows-fullscreen display-4 text-danger mb-3"></i>
                        <h5>Listen & Speak Simultaneously</h5>
                        <p class="text-muted small">Unlike traditional systems, PersonaPlex can listen while speaking, enabling natural turn-taking.</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card h-100 border-0 shadow-sm">
                    <div class="card-body text-center p-4">
                        <i class="bi bi-chat-dots display-4 text-primary mb-3"></i>
                        <h5>Natural Interruptions</h5>
                        <p class="text-muted small">Interrupt the AI naturally, just like in a real conversation. No awkward pauses.</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card h-100 border-0 shadow-sm">
                    <div class="card-body text-center p-4">
                        <i class="bi bi-emoji-smile display-4 text-success mb-3"></i>
                        <h5>Backchannels</h5>
                        <p class="text-muted small">Natural conversational cues like "uh-huh", "I see", "go on" to show active listening.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Use Cases -->
<section class="py-5">
    <div class="container">
        <h2 class="text-center fw-bold mb-5">Use Cases</h2>
        <div class="row g-4">
            <div class="col-md-3">
                <div class="text-center">
                    <i class="bi bi-headset display-4 text-primary mb-3"></i>
                    <h6>Customer Support</h6>
                    <p class="text-muted small">Build voice agents that handle complex customer conversations naturally.</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="text-center">
                    <i class="bi bi-translate display-4 text-success mb-3"></i>
                    <h6>Language Practice</h6>
                    <p class="text-muted small">Practice speaking any language with a patient, native-sounding AI tutor.</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="text-center">
                    <i class="bi bi-briefcase display-4 text-warning mb-3"></i>
                    <h6>Interview Practice</h6>
                    <p class="text-muted small">Prepare for job interviews with realistic AI-powered mock interviews.</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="text-center">
                    <i class="bi bi-robot display-4 text-info mb-3"></i>
                    <h6>Voice Assistants</h6>
                    <p class="text-muted small">Create custom voice assistants for your applications and products.</p>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block scripts %}
<script>
/**
 * Real-Time Voice Chat - Powered by DeepSeek AI
 * Connects to the backend API for true AI-powered conversations
 */
document.addEventListener('DOMContentLoaded', function() {
    const callBtn = document.getElementById('callBtn');
    const chatMessages = document.getElementById('chatMessages');
    const muteBtn = document.getElementById('muteBtn');
    const speakerBtn = document.getElementById('speakerBtn');
    const userWaveform = document.getElementById('userWaveform');
    const aiWaveform = document.getElementById('aiWaveform');

    // Session state
    let sessionId = null;
    let isCallActive = false;
    let isProcessing = false;
    let recognition = null;
    let isMuted = false;
    let isSpeakerOn = true;
    let turnCount = 0;
    let sessionStartTime = null;
    let audioContext = null;

    // Stats elements
    const durationEl = document.querySelector('.fs-4.fw-bold.text-primary');
    const latencyEl = document.querySelector('.fs-4.fw-bold.text-success');
    const turnsEl = document.querySelector('.fs-4.fw-bold.text-info');
    const creditsEl = document.querySelector('.fs-4.fw-bold.text-warning');

    // Persona & voice settings
    const personaSelect = document.querySelector('select[name="persona"]') || document.querySelectorAll('.form-select-sm')[0];
    const voiceSelect = document.querySelector('select[name="voice"]') || document.querySelectorAll('.form-select-sm')[1];
    const systemPromptEl = document.querySelector('textarea');

    // Browser speech recognition (for text input to API)
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (SpeechRecognition) {
        recognition = new SpeechRecognition();
        recognition.continuous = false;
        recognition.interimResults = true;
        recognition.lang = 'en-US';

        recognition.onresult = async function(event) {
            const last = event.results.length - 1;
            const transcript = event.results[last][0].transcript;

            if (event.results[last].isFinal && transcript.trim()) {
                animateWaveform(userWaveform, false);
                await processUserInput(transcript.trim());
            }
        };

        recognition.onerror = function(event) {
            console.error('Speech recognition error:', event.error);
            if (event.error === 'not-allowed') {
                addMessage('system', 'Microphone access denied. Please allow microphone access and try again.');
            }
            animateWaveform(userWaveform, false);
        };

        recognition.onend = function() {
            if (isCallActive && !isMuted && !isProcessing) {
                // Brief pause before next listen
                setTimeout(() => {
                    if (isCallActive && !isMuted && !isProcessing) {
                        try {
                            recognition.start();
                            animateWaveform(userWaveform, true);
                        } catch (e) { }
                    }
                }, 500);
            }
        };
    }

    function addMessage(sender, text) {
        const isUser = sender === 'user';
        const isSystem = sender === 'system';

        let bgClass = isUser ? 'bg-primary' : (isSystem ? 'bg-warning' : 'bg-light');
        let textClass = isUser ? 'text-white' : (isSystem ? 'text-dark' : '');
        let smallClass = isUser ? 'text-white-50' : (isSystem ? 'text-dark' : 'text-muted');
        let label = isUser ? 'You' : (isSystem ? 'System' : 'AI Assistant');

        const html = `
            <div class="d-flex ${isUser ? 'justify-content-end' : ''} mb-3">
                <div class="${bgClass} rounded p-3" style="max-width: 80%;">
                    <small class="${smallClass}">${label}</small>
                    <p class="mb-0 ${textClass}">${text}</p>
                </div>
            </div>
        `;
        chatMessages.innerHTML += html;
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    async function startSession() {
        const apiKey = SpeechAPI.getApiKey();
        if (!apiKey) {
            addMessage('system', 'Please log in to use voice chat. Sign up for free to get started!');
            return false;
        }

        try {
            const persona = personaSelect?.value || 'assistant';
            const customPrompt = systemPromptEl?.value || null;

            const response = await fetch(`${SpeechAPI.baseUrl}/v1/voicechat/start/`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${apiKey}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    persona: persona,
                    model: 'deepseek-r1:7b',
                    custom_prompt: customPrompt,
                    tts_model: 'piper'
                })
            });

            if (!response.ok) {
                const error = await response.json();
                if (error.error === 'rate_limit_exceeded') {
                    addMessage('system', 'Daily free minutes used. Upgrade to premium for more voice chat time!');
                } else {
                    addMessage('system', error.message || 'Failed to start session');
                }
                return false;
            }

            const data = await response.json();
            sessionId = data.session_id;
            sessionStartTime = Date.now();

            // Update remaining minutes display if available
            if (data.remaining_minutes !== undefined) {
                creditsEl.textContent = Math.round(data.remaining_minutes);
            }

            return true;
        } catch (error) {
            console.error('Failed to start session:', error);
            addMessage('system', 'Unable to connect to AI service. Please try again.');
            return false;
        }
    }

    async function processUserInput(text) {
        if (!sessionId || isProcessing) return;

        isProcessing = true;
        addMessage('user', text);
        animateWaveform(aiWaveform, true);

        const startTime = Date.now();

        try {
            const apiKey = SpeechAPI.getApiKey();
            const response = await fetch(`${SpeechAPI.baseUrl}/v1/voicechat/turn/`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${apiKey}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    session_id: sessionId,
                    text: text
                })
            });

            const latency = Date.now() - startTime;
            latencyEl.textContent = `${latency}ms`;

            if (!response.ok) {
                throw new Error('API error');
            }

            const data = await response.json();

            // Show response
            addMessage('ai', data.response_text);
            turnCount = data.turn_number || turnCount + 1;
            turnsEl.textContent = turnCount;

            // Play audio response if available and speaker is on
            if (isSpeakerOn && data.response_audio) {
                await playAudioBase64(data.response_audio);
            } else if (isSpeakerOn) {
                // Fallback to browser TTS
                speakBrowser(data.response_text);
            }

        } catch (error) {
            console.error('Chat error:', error);
            addMessage('ai', "I'm having trouble responding right now. Please try again.");
        } finally {
            isProcessing = false;
            animateWaveform(aiWaveform, false);

            // Resume listening if call is active
            if (isCallActive && !isMuted && recognition) {
                setTimeout(() => {
                    try {
                        recognition.start();
                        animateWaveform(userWaveform, true);
                    } catch (e) { }
                }, 300);
            }
        }
    }

    async function playAudioBase64(base64Audio) {
        try {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }

            const audioData = atob(base64Audio);
            const arrayBuffer = new ArrayBuffer(audioData.length);
            const view = new Uint8Array(arrayBuffer);
            for (let i = 0; i < audioData.length; i++) {
                view[i] = audioData.charCodeAt(i);
            }

            const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
            const source = audioContext.createBufferSource();
            source.buffer = audioBuffer;
            source.connect(audioContext.destination);

            animateWaveform(aiWaveform, true);
            source.onended = () => animateWaveform(aiWaveform, false);
            source.start(0);

        } catch (error) {
            console.error('Audio playback error:', error);
            // Fallback to browser TTS
            const text = chatMessages.lastElementChild?.querySelector('p')?.textContent;
            if (text) speakBrowser(text);
        }
    }

    function speakBrowser(text) {
        if (!window.speechSynthesis) return;

        window.speechSynthesis.cancel();
        const utterance = new SpeechSynthesisUtterance(text);
        animateWaveform(aiWaveform, true);
        utterance.onend = () => animateWaveform(aiWaveform, false);
        window.speechSynthesis.speak(utterance);
    }

    async function endSession() {
        if (!sessionId) return;

        try {
            const apiKey = SpeechAPI.getApiKey();
            await fetch(`${SpeechAPI.baseUrl}/v1/voicechat/end/`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${apiKey}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ session_id: sessionId })
            });
        } catch (error) {
            console.error('Error ending session:', error);
        }

        sessionId = null;
    }

    function animateWaveform(waveform, active) {
        const bars = waveform.querySelectorAll('div');
        if (active) {
            bars.forEach(bar => bar.style.animation = 'wave 0.3s ease-in-out infinite alternate');
        } else {
            bars.forEach(bar => bar.style.animation = '');
        }
    }

    function updateDuration() {
        if (!sessionStartTime || !isCallActive) return;

        const elapsed = Math.floor((Date.now() - sessionStartTime) / 1000);
        const mins = Math.floor(elapsed / 60);
        const secs = elapsed % 60;
        durationEl.textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
    }

    // Update duration every second
    setInterval(updateDuration, 1000);

    // Call button handler
    callBtn.addEventListener('click', async function() {
        if (!recognition) {
            addMessage('system', 'Voice recognition not supported in your browser. Try Chrome or Edge.');
            return;
        }

        if (!isCallActive) {
            // Start call
            this.disabled = true;
            this.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';

            const started = await startSession();

            this.disabled = false;

            if (started) {
                isCallActive = true;
                turnCount = 0;
                this.classList.remove('btn-danger');
                this.classList.add('btn-success');
                this.innerHTML = '<i class="bi bi-telephone-x fs-2"></i>';

                chatMessages.innerHTML = '';
                addMessage('ai', "Hello! I'm your AI assistant powered by DeepSeek. How can I help you today?");

                if (isSpeakerOn) {
                    speakBrowser("Hello! I'm your AI assistant powered by DeepSeek. How can I help you today?");
                }

                if (!isMuted) {
                    try {
                        recognition.start();
                        animateWaveform(userWaveform, true);
                    } catch (e) {
                        console.error('Could not start recognition:', e);
                    }
                }
            } else {
                this.innerHTML = '<i class="bi bi-mic fs-2"></i>';
            }
        } else {
            // End call
            isCallActive = false;
            this.classList.remove('btn-success');
            this.classList.add('btn-danger');
            this.innerHTML = '<i class="bi bi-mic fs-2"></i>';

            try {
                recognition.stop();
            } catch (e) { }

            window.speechSynthesis?.cancel();
            animateWaveform(userWaveform, false);
            animateWaveform(aiWaveform, false);

            addMessage('ai', "Thanks for chatting! Talk to you later.");
            await endSession();
        }
    });

    // Mute button
    muteBtn.addEventListener('click', function() {
        isMuted = !isMuted;
        this.innerHTML = isMuted ? '<i class="bi bi-mic-mute"></i>' : '<i class="bi bi-mic"></i>';
        this.classList.toggle('btn-danger', isMuted);
        this.classList.toggle('btn-outline-light', !isMuted);

        if (isCallActive && recognition) {
            if (isMuted) {
                try { recognition.stop(); } catch (e) { }
                animateWaveform(userWaveform, false);
            } else if (!isProcessing) {
                try {
                    recognition.start();
                    animateWaveform(userWaveform, true);
                } catch (e) { }
            }
        }
    });

    // Speaker button
    speakerBtn.addEventListener('click', function() {
        isSpeakerOn = !isSpeakerOn;
        this.innerHTML = isSpeakerOn ? '<i class="bi bi-volume-up"></i>' : '<i class="bi bi-volume-mute"></i>';
        this.classList.toggle('btn-danger', !isSpeakerOn);
        this.classList.toggle('btn-outline-light', isSpeakerOn);

        if (!isSpeakerOn) {
            window.speechSynthesis?.cancel();
            animateWaveform(aiWaveform, false);
        }
    });

    // Check API health on load
    (async function checkHealth() {
        try {
            const response = await fetch(`${SpeechAPI.baseUrl}/v1/voicechat/health/`);
            const data = await response.json();

            if (data.status !== 'healthy') {
                console.warn('Voice chat service:', data);
            }
        } catch (e) {
            console.warn('Voice chat health check failed:', e);
        }
    })();
});
</script>
<style>
@keyframes wave {
    0% { height: 10px; }
    100% { height: 25px; }
}
</style>
{% endblock %}
